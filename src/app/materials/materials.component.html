<div class="container">
  <h2>Materials</h2>
  <button *ngIf="canEdit" class="add-button" (click)="openAddMaterialModal()">
    <mat-icon>upload_file</mat-icon>
    Add Material
  </button>
  <div *ngIf="materials.length > 0; else noMaterials">
    <div *ngFor="let material of materials" class="material-item">
      <div class="material-header">
        <h3>{{ material.title }}</h3>
        <div class="action-buttons">
          <button
            *ngIf="canEdit"
            class="edit-button"
            (click)="openEditMaterialModal(material)"
          >
            <mat-icon>edit</mat-icon>
          </button>
          <button
            *ngIf="canEdit"
            class="delete-button"
            (click)="deleteMeterial(material.id)"
          >
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
      <p>{{ material.description }}</p>

      <div *ngIf="material.files && material.files.length > 0">
        <div *ngFor="let file of material.files" class="file-item">
          <img [src]="getFileIcon(file.type)" class="file-icon" />
          <a (click)="downloadFile(file)">{{ file.name }}</a>
        </div>
      </div>

      <hr />
    </div>
  </div>

  <ng-template #noMaterials>
    <p class="no-materials">No materials available for this course.</p>
  </ng-template>

  <!-- preload icons (hidden) -->
  <img src="assets/icons/pdf.png" style="display: none" />
  <img src="assets/icons/image.png" style="display: none" />
  <img src="assets/icons/doc.png" style="display: none" />
  <img src="assets/icons/xls.png" style="display: none" />
  <img src="assets/icons/zip.png" style="display: none" />
  <img src="assets/icons/file.png" style="display: none" />
</div>

<div class="modal-backdrop" *ngIf="showAddModal">
  <div class="modal">
    <h3>Add Material</h3>

    <input placeholder="Title" [(ngModel)]="newMaterial.title" />

    <textarea placeholder="Description" [(ngModel)]="newMaterial.description">
    </textarea>

    <!-- Visibility Toggle -->
    <label class="visibility-toggle">
      <input type="checkbox" [(ngModel)]="newMaterial.visible" />
      <span>Visible to Students</span>
    </label>

    <input type="file" (change)="onFilesSelected($event)" multiple />

    <div class="modal-buttons">
      <button (click)="submitNewMaterial()">Save</button>
      <button
        class="cancel"
        (keydown.esc)="closeAddMaterialModal($event)"
        (click)="closeAddMaterialModal()"
      >
        Cancel
      </button>
    </div>
  </div>
</div>
<div class="modal-backdrop" *ngIf="showEditModal">
  <div class="modal">
    <h3>Edit Material</h3>

    <input placeholder="Title" [(ngModel)]="editMaterialData.title" />

    <textarea
      placeholder="Description"
      [(ngModel)]="editMaterialData.description"
    ></textarea>

    <label class="visibility-toggle">
      <input type="checkbox" [(ngModel)]="editMaterialData.visible" />
      <span>Visible to Students</span>
    </label>

    <div
      *ngIf="
        editingMaterial &&
        editingMaterial.files &&
        editingMaterial.files.length > 0
      "
      class="existing-files"
    >
      <h4>Existing Files:</h4>
      
      <div *ngFor="let file of editingMaterial.files" class="file-item-delete">
        
        <div class="file-info">
          <img [src]="getFileIcon(file.type)" class="file-icon-small" />
          
          <span [class.deleted-text]="deletedFileIds.includes(file.id)">
            {{ file.name }}
          </span>
        </div>

        <button
          class="delete-file-btn"
          (click)="markFileForDeletion(file.id)"
          [class.deleted]="deletedFileIds.includes(file.id)"
          [title]="deletedFileIds.includes(file.id) ? 'Undo delete' : 'Delete file'"
        >
          <mat-icon>{{ deletedFileIds.includes(file.id) ? 'restore' : 'delete' }}</mat-icon>
        </button>
      </div>
    </div>
    <input type="file" (change)="onEditFilesSelected($event)" multiple />

    <div class="modal-buttons">
      <button (click)="submitEditedMaterial()">Save</button>
      <button class="cancel" (click)="closeEditMaterialModal()">Cancel</button>
    </div>
  </div>
</div>
